// FlowLogic AI Intelligence Platform - Simplified Schema
// Strategic pivot: AI add-on for existing WMS systems
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// COMPANY & WAREHOUSE STRUCTURE (Reference Data)
// ============================================

model Company {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String   @default("USA")
  phone       String?
  email       String?
  website     String?
  taxId       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  warehouses  Warehouse[]
  users       User[]
  integrations Integration[]

  @@map("companies")
}

model Warehouse {
  id              String   @id @default(uuid())
  code            String
  name            String
  address         String?
  city            String?
  state           String?
  zipCode         String?
  country         String   @default("USA")
  timezone        String   @default("America/New_York")
  isActive        Boolean  @default(true)
  isDefault       Boolean  @default(false)
  squareFootage   Int?
  maxCapacity     Int?
  operatingHours  Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])

  zones           Zone[]
  docks           Dock[]
  users           UserWarehouse[]
  alerts          Alert[]

  @@unique([companyId, code])
  @@map("warehouses")
}

model Zone {
  id              String   @id @default(uuid())
  code            String
  name            String
  type            ZoneType @default(STORAGE)
  description     String?
  pickSequence    Int      @default(0)
  isActive        Boolean  @default(true)
  temperature     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])

  locations       Location[]

  @@unique([warehouseId, code])
  @@map("zones")
}

enum ZoneType {
  RECEIVING
  STORAGE
  PICKING
  PACKING
  STAGING
  SHIPPING
  RETURNS
  QUARANTINE
  QUALITY
  CROSSDOCK
}

model Location {
  id              String   @id @default(uuid())
  code            String
  barcode         String?
  type            LocationType @default(STORAGE)
  aisle           String?
  bay             String?
  level           String?
  position        String?
  maxWeight       Decimal? @db.Decimal(10, 2)
  maxVolume       Decimal? @db.Decimal(10, 2)
  maxPallets      Int?
  width           Decimal? @db.Decimal(10, 2)
  height          Decimal? @db.Decimal(10, 2)
  depth           Decimal? @db.Decimal(10, 2)
  pickSequence    Int      @default(0)
  putawaySequence Int      @default(0)
  isActive        Boolean  @default(true)
  isPickable      Boolean  @default(true)
  isPutawayable   Boolean  @default(true)
  isReplenishable Boolean  @default(true)
  minQuantity     Int?
  maxQuantity     Int?
  reorderPoint    Int?
  velocityCode    String?
  lastCountDate   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  zoneId          String
  zone            Zone     @relation(fields: [zoneId], references: [id])

  @@unique([zoneId, code])
  @@map("locations")
}

enum LocationType {
  STORAGE
  PICK_FACE
  BULK
  FLOOR
  RACK
  SHELF
  BIN
  PALLET
  STAGING
  DOCK
  QUALITY_HOLD
  DAMAGE
  RETURNS
  FWRD          // Forward pick location (reserve-type)
  RESERVE       // General reserve location
  MPP           // Multi-Product Pallet location
}

model Dock {
  id              String   @id @default(uuid())
  code            String
  name            String
  type            DockType @default(BOTH)
  isActive        Boolean  @default(true)
  currentStatus   DockStatus @default(AVAILABLE)
  assignedCarrier String?
  appointmentTime DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([warehouseId, code])
  @@map("docks")
}

enum DockType {
  RECEIVING
  SHIPPING
  BOTH
}

enum DockStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id              String   @id @default(uuid())
  username        String   @unique
  email           String   @unique
  passwordHash    String
  firstName       String
  lastName        String
  fullName        String?

  role            UserRole @default(OPERATOR)
  departmentId    String?

  phone           String?
  employeeId      String?

  defaultWarehouseId String?
  locale          String   @default("en-US")
  timezone        String   @default("America/New_York")

  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?

  // Password reset
  passwordResetToken   String?
  passwordResetExpires DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])

  warehouses      UserWarehouse[]
  auditLogs       AuditLog[]
  notificationSettings NotificationSetting[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  SUPERVISOR
  OPERATOR
  PICKER
  PACKER
  RECEIVER
  SHIPPER
  VIEWER
  API
}

model UserWarehouse {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@unique([userId, warehouseId])
  @@map("user_warehouses")
}

// ============================================
// INTEGRATIONS & CONNECTORS
// ============================================

model Integration {
  id              String   @id @default(uuid())
  name            String
  type            IntegrationType
  status          IntegrationStatus @default(INACTIVE)

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])

  endpoint        String?
  apiKey          String?
  apiSecret       String?
  username        String?
  password        String?

  settings        Json?

  lastSyncAt      DateTime?
  lastErrorAt     DateTime?
  lastError       String?

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  logs            IntegrationLog[]

  @@map("integrations")
}

enum IntegrationType {
  ERP
  ECOMMERCE
  SHIPPING
  EDI
  API
  FTP
  WEBHOOK
  SAP
  ORACLE
  NETSUITE
  DYNAMICS
  QUICKBOOKS
  SHOPIFY
  AMAZON
  WALMART
  MAGENTO
  MANHATTAN
  BLUE_YONDER
  INFOR
  KORBER
  HIGHJUMP
  CUSTOM_WMS
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  SYNCING
}

model IntegrationLog {
  id              String   @id @default(uuid())
  integrationId   String
  integration     Integration @relation(fields: [integrationId], references: [id])

  direction       String
  messageType     String
  referenceId     String?
  referenceNumber String?

  status          String
  requestData     Json?
  responseData    Json?
  errorMessage    String?

  processedAt     DateTime @default(now())

  @@index([integrationId, processedAt])
  @@map("integration_logs")
}

// ============================================
// ALERTS & NOTIFICATIONS
// ============================================

model Alert {
  id              String   @id @default(uuid())
  type            AlertType
  severity        AlertSeverity @default(INFO)

  title           String
  message         String

  warehouseId     String?
  warehouse       Warehouse? @relation(fields: [warehouseId], references: [id])

  entityType      String?
  entityId        String?

  isRead          Boolean  @default(false)
  isResolved      Boolean  @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?

  suggestedAction String?
  aiConfidence    Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([warehouseId, createdAt])
  @@index([type, severity])
  @@map("alerts")
}

enum AlertType {
  INVENTORY_DISCREPANCY
  LOW_STOCK
  OVERSTOCK
  ORDER_LATE
  ORDER_EXCEPTION
  RECEIPT_ISSUE
  LABOR_PERFORMANCE
  SYSTEM_ERROR
  INTEGRATION_ERROR
  EXPIRATION_WARNING
  CAPACITY_WARNING
  CUSTOM
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
  EMERGENCY
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id              String   @id @default(uuid())
  entityType      String
  entityId        String
  action          String

  userId          String?
  user            User?    @relation(fields: [userId], references: [id])

  oldValues       Json?
  newValues       Json?

  ipAddress       String?
  userAgent       String?

  createdAt       DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  dataType    String   @default("string")
  category    String?
  isEncrypted Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

// ============================================
// AI CHAT SESSIONS
// ============================================

model ChatSession {
  id          String   @id @default(uuid())
  sessionId   String   @unique
  title       String?

  userId      String?

  messageCount Int     @default(0)
  lastMessageAt DateTime?

  isArchived  Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    ChatMessage[]

  @@index([userId, createdAt])
  @@map("chat_sessions")
}

model ChatMessage {
  id          String   @id @default(uuid())
  sessionId   String
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role        ChatRole
  content     String

  toolsUsed   String[]
  analysis    Json?
  actions     Json?

  tokenCount  Int?
  modelId     String?

  createdAt   DateTime @default(now())

  @@index([sessionId, createdAt])
  @@map("chat_messages")
}

enum ChatRole {
  user
  assistant
  system
}

// ============================================
// FLOWLOGIC INTELLIGENCE PLATFORM
// Data ingestion, truth engine, root cause analysis
// ============================================

model DataIngestion {
  id            String   @id @default(uuid())
  filename      String
  filePath      String
  dataType      String
  source        String
  mappingType   String   @default("generic")
  recordCount   Int      @default(0)
  errorCount    Int      @default(0)
  status        String   @default("PENDING")
  metadata      Json?
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  inventorySnapshots  InventorySnapshot[]
  transactionSnapshots TransactionSnapshot[]
  adjustmentSnapshots  AdjustmentSnapshot[]
  cycleCountSnapshots  CycleCountSnapshot[]

  @@index([dataType, createdAt])
  @@map("data_ingestions")
}

model ScheduledIngestion {
  id              String   @id @default(uuid())
  name            String
  source          String
  connectionConfig String
  schedule        String
  dataType        String
  mappingType     String   @default("generic")
  isActive        Boolean  @default(true)
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("scheduled_ingestions")
}

model InventorySnapshot {
  id              String   @id @default(uuid())
  ingestionId     String
  ingestion       DataIngestion @relation(fields: [ingestionId], references: [id])

  sku             String
  locationCode    String
  locationType    String?        // FWRD, RESERVE, MPP, etc.
  licensePlate    String?        // LP/Pallet ID for tracking fragmentation
  quantityOnHand  Float
  quantityAllocated Float @default(0)
  quantityAvailable Float @default(0)
  lotNumber       String?
  expirationDate  DateTime?
  snapshotDate    DateTime @default(now())
  rawData         Json?

  @@index([sku, locationCode])
  @@index([snapshotDate])
  @@index([locationCode, licensePlate])
  @@map("inventory_snapshots")
}

model TransactionSnapshot {
  id                    String   @id @default(uuid())
  ingestionId           String
  ingestion             DataIngestion @relation(fields: [ingestionId], references: [id])

  externalTransactionId String?
  type                  String
  sku                   String
  fromLocation          String?
  toLocation            String?
  quantity              Float
  userId                String?
  transactionDate       DateTime
  rawData               Json?

  @@index([sku, transactionDate])
  @@index([type, transactionDate])
  @@map("transaction_snapshots")
}

model AdjustmentSnapshot {
  id              String   @id @default(uuid())
  ingestionId     String
  ingestion       DataIngestion @relation(fields: [ingestionId], references: [id])

  sku             String
  locationCode    String
  adjustmentQty   Float
  reason          String
  reasonCode      String?
  userId          String?
  adjustmentDate  DateTime @default(now())
  rawData         Json?

  @@index([sku, adjustmentDate])
  @@index([locationCode, adjustmentDate])
  @@index([reason])
  @@map("adjustment_snapshots")
}

model CycleCountSnapshot {
  id              String   @id @default(uuid())
  ingestionId     String
  ingestion       DataIngestion @relation(fields: [ingestionId], references: [id])

  sku             String
  locationCode    String
  systemQty       Float
  countedQty      Float
  variance        Float
  variancePercent Float
  counterId       String?
  countDate       DateTime @default(now())
  rawData         Json?

  @@index([sku, locationCode])
  @@index([countDate])
  @@index([variance])
  @@map("cycle_count_snapshots")
}

// Detected discrepancies
model Discrepancy {
  id              String   @id @default(uuid())
  type            String
  severity        String
  status          String   @default("OPEN")

  sku             String?
  locationCode    String?
  expectedQty     Float?
  actualQty       Float?
  variance        Float
  variancePercent Float?
  varianceValue   Float?

  description     String?
  evidence        Json?
  rootCause       String?
  rootCauseCategory String?
  resolution      String?

  detectedAt      DateTime @default(now())
  resolvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  investigations  Investigation[]
  actions         ActionRecommendation[]

  @@index([type, status])
  @@index([severity, status])
  @@index([sku])
  @@index([locationCode])
  @@index([createdAt])
  @@map("discrepancies")
}

model Investigation {
  id              String   @id @default(uuid())
  discrepancyId   String
  discrepancy     Discrepancy @relation(fields: [discrepancyId], references: [id])

  rootCause       String?
  category        String?
  notes           String?
  evidence        Json?

  assignedTo      String?
  userId          String?
  status          String   @default("OPEN")
  confirmedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([discrepancyId])
  @@index([status])
  @@map("investigations")
}

model ActionRecommendation {
  id              String   @id @default(uuid())
  type            String
  priority        Int      @default(3)
  status          String   @default("PENDING")

  discrepancyId   String?
  discrepancy     Discrepancy? @relation(fields: [discrepancyId], references: [id])

  sku             String?
  locationCode    String?
  description     String
  instructions    String?
  estimatedImpact Float?

  assignedTo      String?
  completedBy     String?
  notes           String?

  exportedAt      DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type, status])
  @@index([priority, status])
  @@index([discrepancyId])
  @@map("action_recommendations")
}

model ScheduledReport {
  id          String   @id @default(uuid())
  reportType  String
  schedule    String
  recipients  String
  format      String   @default("pdf")
  isActive    Boolean  @default(true)
  lastSentAt  DateTime?
  nextSendAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("scheduled_reports")
}

// ============================================
// ITEM PARAMETERS (For systematic issue detection)
// ============================================

model ItemParameter {
  id              String   @id @default(uuid())
  sku             String   @unique
  description     String?
  category        String?

  // Pack configuration
  shelfPack       Int      @default(1)      // Units per shelf pack
  casePack        Int      @default(1)      // Units per case
  innerPack       Int?                       // Units per inner pack
  palletQty       Int?                       // Units per pallet

  // Order parameters
  targetOrderMin  Int?                       // Minimum order quantity
  maxStoreOrder   Int?                       // Maximum store order
  reorderPoint    Int?                       // Reorder trigger point
  safetyStock     Int?                       // Safety stock level

  // Costs
  unitCost        Float?                     // Unit cost for impact calculation
  vendorCost      Float?                     // Cost from vendor

  // Status
  isActive        Boolean  @default(true)
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Store demand analysis data
  demandData      Json?                      // Store order patterns, daily demand stats

  @@index([category])
  @@index([isActive])
  @@map("item_parameters")
}

// ============================================
// NOTIFICATION SETTINGS
// ============================================

model NotificationSetting {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  // Event type this setting applies to
  eventType       NotificationEventType

  // Channel preferences
  emailEnabled    Boolean  @default(true)
  smsEnabled      Boolean  @default(false)
  pushEnabled     Boolean  @default(false)
  inAppEnabled    Boolean  @default(true)

  // Additional recipients (comma-separated emails)
  recipients      String?

  // Frequency settings
  frequency       NotificationFrequency @default(IMMEDIATE)
  digestTime      String?               // Time for digest (e.g., "09:00")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, eventType])
  @@map("notification_settings")
}

enum NotificationEventType {
  ALERT_CRITICAL
  ALERT_HIGH
  ALERT_MEDIUM
  ALERT_LOW
  DISCREPANCY_DETECTED
  ANALYSIS_COMPLETE
  SYNC_FAILED
  SYNC_COMPLETE
  TRIAL_ENDING
  WEEKLY_DIGEST
  SYSTEM_UPDATE
}

enum NotificationFrequency {
  IMMEDIATE
  HOURLY
  DAILY
  WEEKLY
}

// Email log for tracking sent notifications
model EmailLog {
  id              String   @id @default(uuid())
  userId          String?
  recipientEmail  String

  eventType       String
  subject         String
  templateName    String?

  status          EmailStatus @default(PENDING)
  sentAt          DateTime?
  errorMessage    String?

  metadata        Json?

  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@index([status])
  @@map("email_logs")
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}
